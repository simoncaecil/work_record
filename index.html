<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì¡°êµ ì—…ë¬´ ì¼ì§€</title>
<style>
  :root[data-theme="light"]{
    --bg:#f6f7fb; --card:#ffffff; --muted:#64748b; --text:#0f172a; --accent:#2563eb;
    --line:#e5e7eb; --good:#10b981; --warn:#f59e0b;
    --input:#ffffff; --input-border:#d1d5db; --row:#ffffff; --row-border:#e5e7eb;
    --btn:#f8fafc; --btn-border:#d1d5db; --btn-text:#0f172a;
  }
  :root[data-theme="dark"]{
    --bg:#0b0c10; --card:#121318; --muted:#9aa3af; --text:#e5e7eb; --accent:#60a5fa;
    --line:#22252e; --good:#34d399; --warn:#fbbf24;
    --input:#0f1117; --input-border:#222532; --row:#0f1117; --row-border:#222532;
    --btn:#151823; --btn-border:#2a2f3a; --btn-text:#e6e9ef;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,"Noto Sans KR",sans-serif}
  header{padding:18px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);backdrop-filter:saturate(180%) blur(4px);z-index:2}
  h1{margin:0;font-size:20px;letter-spacing:.3px}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .grid{display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted)}
  input[type="text"], textarea, select, input[type="datetime-local"]{
    background:var(--input);border:1px solid var(--input-border);color:var(--text);
    padding:10px 12px;border-radius:10px;outline:none;min-width:0
  }
  textarea{width:100%;min-height:90px;resize:vertical}
  input[type="text"]{width:220px}
  .btn{
    border:1px solid var(--btn-border);background:var(--btn);color:var(--btn-text);
    border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer
  }
  .btn:hover{filter:brightness(0.98)}
  .btn.primary{background:var(--btn);border-color:#cbd5e1}
  .btn.accent{background:color-mix(in srgb,var(--accent) 12%, var(--btn));border-color:color-mix(in srgb,var(--accent) 35%, var(--btn-border));color:color-mix(in srgb,var(--accent) 90%, #ffffff)}
  .btn.good{background:color-mix(in srgb,var(--good) 12%, var(--btn));border-color:color-mix(in srgb,var(--good) 35%, var(--btn-border))}
  .btn.warn{background:color-mix(in srgb,var(--warn) 12%, var(--btn));border-color:color-mix(in srgb,var(--warn) 35%, var(--btn-border))}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--btn-border);font-size:12px}
  .badge.asap{border-color:var(--accent);color:color-mix(in srgb,var(--accent) 70%, var(--text))}
  .badge.today{border-color:var(--warn);color:color-mix(in srgb,var(--warn) 70%, var(--text))}
  .badge.dt{border-color:var(--good);color:color-mix(in srgb,var(--good) 70%, var(--text))}
  .controls .row{align-items:flex-end}
  .controls select{height:40px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:left;padding:0 10px}
  tbody tr{background:var(--row);border:1px solid var(--row-border)}
  tbody tr td{padding:12px 10px;vertical-align:top}
  tbody tr{border-radius:12px;overflow:hidden}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .muted{color:var(--muted)}
  .nowrap{white-space:nowrap}
  .content{white-space:pre-wrap;line-height:1.35}
  .tcenter{text-align:center}
  .pagination{display:flex;justify-content:center;gap:8px;margin-top:10px;flex-wrap:wrap}
  .pagination button{min-width:40px}
  .kicker{font-size:12px;color:var(--muted)}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .small{font-size:12px}
  .sticky-tools{position:sticky;bottom:14px;display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .right{margin-left:auto}
  @media (max-width:860px){
    .hide-sm{display:none}
    input[type="text"]{width:100%}
  }
</style>
</head>
<body>
<header>
  <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
    <div>
      <h1>ì¡°êµ ì—…ë¬´ ì¼ì§€</h1>
      <div class="kicker">Google Sheets ì—°ë™ Â· ì—¬ëŸ¬ ì‚¬ìš©ì ê³µë™ ì‚¬ìš©</div>
    </div>
    <button id="themeBtn" class="btn" title="ë‹¤í¬/ë¼ì´íŠ¸ ì „í™˜">ğŸŒ ë¼ì´íŠ¸</button>
  </div>
</header>

<div class="wrap grid">

  <!-- ì…ë ¥ ì¹´ë“œ -->
  <section class="card">
    <div class="row">
      <div style="flex:1 1 240px">
        <label>ì‘ì„±ì</label><br/>
        <input id="author" type="text" placeholder="ì˜ˆ: ë¯¼ê³¼ì¥ / ê¹€ì¡°êµ" />
      </div>
      <div style="flex:3 1 480px">
        <label>ì—…ë¬´ ë‚´ìš©</label><br/>
        <textarea id="content" placeholder="ì˜ˆ: 5í•™ë…„ vocabulary ì‹œí—˜ì§€ ì¸ì‡„ ë° ë¶„ë°˜ë³„ ë°°ë¶€ / ê´€ë ¨: 5A, 5B (ASAP)"></textarea>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>ê¸°í•œ ì„ íƒ</label><br/>
        <div class="row small">
          <label><input type="radio" name="ddl" value="ASAP" checked> ASAP</label>
          <label><input type="radio" name="ddl" value="TODAY"> ë‹¹ì¼</label>
          <label><input type="radio" name="ddl" value="DATETIME"> ì¼ì‹œ ì§€ì •</label>
        </div>
      </div>
      <div>
        <label class="hide-sm"> </label><br/>
        <input id="deadlineAt" type="datetime-local" disabled>
      </div>
      <div class="right" style="align-self:flex-end">
        <button id="addBtn" class="btn accent">ì—…ë¬´ ë“±ë¡</button>
      </div>
    </div>
    <div class="hr"></div>
    <div class="small muted">â€» ë‚´ìš©ì— ê´€ë ¨ ì¸ì›/ì—…ë¬´ ì„±ê²©ì€ ììœ ë¡­ê²Œ. ê¸°í•œì€ ìœ„ì—ì„œ ì„ íƒ.</div>
  </section>

  <!-- ëª©ë¡ ì»¨íŠ¸ë¡¤ -->
  <section class="card controls">
    <div class="row">
      <div>
        <label>ì •ë ¬</label><br/>
        <select id="sortMode">
          <option value="NEW_FIRST">ì…ë ¥ìˆœ (ìµœì‹  â†’ ì˜¤ë˜ëœ)</option>
          <option value="OLD_FIRST">ì…ë ¥ìˆœ (ì˜¤ë˜ëœ â†’ ìµœì‹ )</option>
          <option value="INCOMPLETE_FIRST">ìƒíƒœ ì •ë ¬: ë¯¸ì™„ë£Œ ë¨¼ì €</option>
          <option value="COMPLETE_FIRST">ìƒíƒœ ì •ë ¬: ì™„ë£Œ ë¨¼ì €</option>
        </select>
      </div>
      <div>
        <label>ìƒíƒœ ë¹ ë¥¸ í•„í„°</label><br/>
        <select id="statusFilter">
          <option value="ALL">ì „ì²´</option>
          <option value="OPEN">ë¯¸ì™„ë£Œ(ì²´í¬ ë¯¸ì¶©ì¡±)</option>
          <option value="DONE">ì™„ë£Œ(ì‘ì„±ì+ê³¼ì¥ ì²´í¬)</option>
        </select>
      </div>
      <div class="row right">
        <button id="refreshBtn" class="btn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
  </section>

  <!-- ëª©ë¡ í‘œ -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="small muted">í˜ì´ì§€ë‹¹ 10ê°œ í‘œì‹œ</div>
      <div class="small muted">ì™„ë£Œ ê¸°ì¤€: <b>ì‘ì„±ì ì™„ë£Œ</b> + <b>ê³¼ì¥ ì²´í¬</b> ëª¨ë‘ ì²´í¬</div>
    </div>
    <table>
      <thead>
        <tr>
          <th class="hide-sm">#</th>
          <th>ì…ë ¥ì‹œê°</th>
          <th>ì‘ì„±ì</th>
          <th>ì—…ë¬´ ë‚´ìš©</th>
          <th>ê¸°í•œ</th>
          <th class="tcenter">ì‘ì„±ì ì™„ë£Œ</th>
          <th class="tcenter">ê³¼ì¥ ì²´í¬</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="pagination" id="pager"></div>
    <div class="sticky-tools">
      <button id="incompleteFirst" class="btn primary">ë¯¸ì™„ë£Œ ë¨¼ì €</button>
      <button id="completeFirst" class="btn good">ì™„ë£Œ ë¨¼ì €</button>
      <button id="resetSort" class="btn">ì…ë ¥ìˆœ</button>
    </div>
  </section>

</div>

<script>
(function(){
  // â˜…â˜…â˜… ì—¬ê¸° ì›¹ì•± URL ë¶™ì—¬ë„£ê¸° â˜…â˜…â˜…
  const API = 'https://script.google.com/macros/s/AKfycbymTKFzsg16HTX_0V-W-r89g9p9sJPkxeyiYJH74MJ6GzccIq7kHXcB6jqbge0FZBEg/exec';

  const tz = "Asia/Seoul";
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);

  const state = { tasks: [], page:1, pageSize:10, sortMode:'NEW_FIRST', statusFilter:'ALL' };

  // ==== THEME ====
  const THEME_KEY = "assistant_tasklog_theme";
  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    const btn = $("#themeBtn");
    btn.textContent = theme==="dark" ? "ğŸŒ™ ë‹¤í¬" : "ğŸŒ ë¼ì´íŠ¸";
    localStorage.setItem(THEME_KEY, theme);
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "light";
    applyTheme(cur==="light" ? "dark" : "light");
  }
  function initTheme(){
    applyTheme(localStorage.getItem(THEME_KEY) || "light");
    $("#themeBtn").addEventListener("click", toggleTheme);
  }

  // ==== Utils ====
  const pad = n => String(n).padStart(2,"0");
  function fmtKST(iso){
    try{
      return new Date(iso).toLocaleString("ko-KR",{ timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(e){ return iso; }
  }
  function fmtDeadline(task){
    if(task.deadlineType==="ASAP") return `<span class="badge asap">ASAP</span>`;
    if(task.deadlineType==="TODAY"){
      const d = new Date(task.createdAt);
      const y = d.toLocaleString("ko-KR",{timeZone:tz,year:"numeric"});
      const m = pad(d.toLocaleString("ko-KR",{timeZone:tz,month:"2-digit"}));
      const day = pad(d.toLocaleString("ko-KR",{timeZone:tz,day:"2-digit"}));
      return `<span class="badge today">ë‹¹ì¼ (${y}-${m}-${day})</span>`;
    }
    if(task.deadlineType==="DATETIME"){
      return `<span class="badge dt">${fmtKST(task.deadlineAt)}</span>`;
    }
    return "";
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // ==== API ====
  async function apiList(){
    const r = await fetch(API + '?op=list', { method:'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error('list failed');
    return j.tasks;
  }
  async function apiAdd(payload){
    // preflight í”¼í•˜ë ¤ê³  text/plain
    const r = await fetch(API, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({op:'add', ...payload}) });
    const j = await r.json();
    if(!j.ok) throw new Error('add failed');
    return j.taskId;
  }
  async function apiUpdate(payload){
    const r = await fetch(API, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({op:'update', ...payload}) });
    const j = await r.json();
    if(!j.ok) throw new Error('update failed');
  }

  // ==== State/Render ====
  function isComplete(t){ return !!t.authorDone && !!t.managerChecked; }

  function getSortedFiltered(){
    let arr = state.tasks.slice();
    if(state.statusFilter==="OPEN") arr = arr.filter(t=>!isComplete(t));
    if(state.statusFilter==="DONE") arr = arr.filter(t=>isComplete(t));

    if(state.sortMode==="NEW_FIRST"){ arr.sort((a,b)=>b.id - a.id); }
    else if(state.sortMode==="OLD_FIRST"){ arr.sort((a,b)=>a.id - b.id); }
    else if(state.sortMode==="INCOMPLETE_FIRST"){
      const A = arr.filter(t=>!isComplete(t)).sort((a,b)=>a.id - b.id);
      const B = arr.filter(t=>isComplete(t)).sort((a,b)=>a.id - b.id);
      arr = A.concat(B);
    }else if(state.sortMode==="COMPLETE_FIRST"){
      const A = arr.filter(t=>isComplete(t)).sort((a,b)=>a.id - b.id);
      const B = arr.filter(t=>!isComplete(t)).sort((a,b)=>a.id - b.id);
      arr = A.concat(B);
    }
    return arr;
  }

  function render(){
    const tbody = $("#tbody");
    tbody.innerHTML = "";
    const arr = getSortedFiltered();
    const totalPages = Math.max(1, Math.ceil(arr.length / state.pageSize));
    if(state.page > totalPages) state.page = totalPages;

    const start = (state.page - 1) * state.pageSize;
    const pageItems = arr.slice(start, start + state.pageSize);

    for(const t of pageItems){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="hide-sm mono muted">#${t.id}</td>
        <td class="mono nowrap">${fmtKST(t.createdAt)}</td>
        <td class="nowrap">${escapeHtml(t.author||"")}</td>
        <td class="content">${escapeHtml(t.content||"")}</td>
        <td class="nowrap">${fmtDeadline(t)}</td>
        <td class="tcenter">
          <input type="checkbox" ${t.authorDone?"checked":""} data-act="authorDone" data-id="${t.id}">
          ${t.authorDoneAt?`<div class="small muted">${fmtKST(t.authorDoneAt)}</div>`:""}
        </td>
        <td class="tcenter">
          <input type="checkbox" ${t.managerChecked?"checked":""} data-act="managerChecked" data-id="${t.id}">
          ${t.managerCheckedAt?`<div class="small muted">${fmtKST(t.managerCheckedAt)}</div>`:""}
        </td>
      `;
      tbody.appendChild(tr);
    }
    renderPager(totalPages);
  }

  function renderPager(totalPages){
    const pager = $("#pager");
    pager.innerHTML = "";
    const mkBtn = (label, disabled, onClick)=>{
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = label;
      b.disabled = disabled;
      b.addEventListener("click", onClick);
      pager.appendChild(b);
    };
    mkBtn("Â« ì²˜ìŒ", state.page===1, ()=>{ state.page=1; render(); });
    mkBtn("â€¹ ì´ì „", state.page===1, ()=>{ state.page--; render(); });

    const windowSize = 5;
    let start = Math.max(1, state.page - Math.floor(windowSize/2));
    let end = Math.min(totalPages, start + windowSize - 1);
    if(end - start + 1 < windowSize) start = Math.max(1, end - windowSize + 1);

    for(let p=start; p<=end; p++){
      const b = document.createElement("button");
      b.className = "btn" + (p===state.page ? " primary":"");
      b.textContent = p;
      b.addEventListener("click", ()=>{ state.page=p; render(); });
      pager.appendChild(b);
    }

    mkBtn("ë‹¤ìŒ â€º", state.page===totalPages, ()=>{ state.page++; render(); });
    mkBtn("ë§ˆì§€ë§‰ Â»", state.page===totalPages, ()=>{ state.page=totalPages; render(); });
  }

  // ==== Events ====
  $$('input[name="ddl"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      $("#deadlineAt").disabled = (r.value!=="DATETIME");
    });
  });

  $("#addBtn").addEventListener("click", async ()=>{
    const author = $("#author").value.trim();
    const content = $("#content").value.trim();
    const ddl = [...$$('input[name="ddl"]')].find(x=>x.checked)?.value || "ASAP";
    const dtInput = $("#deadlineAt");

    if(!author){ alert("ì‘ì„±ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
    if(!content){ alert("ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
    if(ddl==="DATETIME" && !dtInput.value){ alert("ê¸°í•œ ì¼ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }

    try{
      await apiAdd({
        author, content,
        deadlineType: ddl,
        deadlineAt: ddl==="DATETIME" ? new Date(dtInput.value).toISOString() : ''
      });
      $("#content").value = "";
      $$('input[name="ddl"]').forEach(x=>{ x.checked = (x.value==="ASAP"); });
      dtInput.value = ""; dtInput.disabled = true;
      await refresh(); // ìµœì‹  ëª©ë¡ ì¬ì¡°íšŒ
    }catch(err){
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜: " + err.message);
    }
  });

  $("#tbody").addEventListener("change", async (e)=>{
    const t = e.target;
    if(!t.matches('input[type="checkbox"][data-id]')) return;
    const id = Number(t.getAttribute("data-id"));
    const act = t.getAttribute("data-act");
    try{
      if(act==="authorDone"){
        await apiUpdate({ id, authorDone: t.checked });
      }else if(act==="managerChecked"){
        await apiUpdate({ id, managerChecked: t.checked });
      }
      await refresh();
    }catch(err){
      alert("ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: " + err.message);
    }
  });

  $("#sortMode").addEventListener("change", (e)=>{ state.sortMode = e.target.value; state.page=1; render(); });
  $("#statusFilter").addEventListener("change", (e)=>{ state.statusFilter = e.target.value; state.page=1; render(); });
  $("#incompleteFirst").addEventListener("click", ()=>{ $("#sortMode").value="INCOMPLETE_FIRST"; state.sortMode="INCOMPLETE_FIRST"; state.page=1; render(); });
  $("#completeFirst").addEventListener("click", ()=>{ $("#sortMode").value="COMPLETE_FIRST"; state.sortMode="COMPLETE_FIRST"; state.page=1; render(); });
  $("#resetSort").addEventListener("click", ()=>{ $("#sortMode").value="NEW_FIRST"; state.sortMode="NEW_FIRST"; state.statusFilter="ALL"; $("#statusFilter").value="ALL"; state.page=1; render(); });
  $("#refreshBtn").addEventListener("click", refresh);

  async function refresh(){
    const tasks = await apiList();
    state.tasks = tasks;
    state.page = 1;
    render();
  }

  // ==== init ====
  initTheme();
  refresh();
})();
</script>
</body>
</html>
